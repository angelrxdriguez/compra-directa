<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compra Directa</title>
    <link rel="stylesheet" href="style/style.css">
    <link rel="icon" href="source/img/Veraleza.png" type="image/png" class="url-logo">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather+Sans:ital,wght@0,300..800;1,300..800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

</head>

<body>
    <input type="hidden" id="tipo-usuario-sesion">

    <nav class="navbar navbar-expand-lg navbar-light bg-light px-4">
        <div class="d-flex align-items-center">
            <a href="perfil.html" class="d-flex align-items-center text-decoration-none text-light">
                <img src="source/img/Veraleza.png" alt="Logo" width="48" height="48" class="me-3 logo">
                <div class="d-flex flex-column">
                    <span class="fw-bold" id="nombre-usuario">...</span>
                    <small class="text-light" id="tipo-usuario">...</small>
                </div>
            </a>
        </div>
        <div class="ms-auto">
            <ul class="navbar-nav flex-row gap-3">
                <li class="nav-item">
                    <a class="nav-link" href="admin.html">Board</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="oferta.html">Ofertas</a>
                </li>
            </ul>
        </div>
    </nav>

<h2 class="tit-tabla2">Revisa La Importación</h2>

<div class="container mt-4">
    <div class="text-end">
    <button class="btn btn-success" id="btn-confirmar-insercion">
      <i class="bi bi-check-circle me-1"></i> Confirmar Inserción
    </button>
  </div>
  <div class="table-responsive table-scroll-container">
    <table class="table table-striped" id="tabla-temp">
      <thead class="table-light">
        <tr>
          <th>Artículo</th>
          <th>Variedad</th>
          <th>Cultivo</th>
          <th>Fecha</th>
          <th>Cajas</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <!-- Aquí se insertarán dinámicamente las filas con JavaScript -->
      </tbody>
    </table>
  </div>

</div>


<!-- Modal Editar Oferta Temporal -->
<div class="modal fade" id="modalEditarTemporal" tabindex="-1" aria-labelledby="modalEditarTemporalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formEditarTemporal">
        <div class="modal-header">
          <h5 class="modal-title" id="modalEditarTemporalLabel">Editar Oferta Temporal</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="edit-temp-id">
          <div class="mb-3">
            <label for="edit-temp-articulo" class="form-label">Artículo</label>
            <select id="edit-temp-articulo" class="form-select" required>
              <option value="Rosa">Rosa</option>
              <option value="Clavel">Clavel</option>
              <option value="Paniculata">Paniculata</option>
              <option value="Alstromelia">Alstromelia</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="edit-temp-variedad" class="form-label">Variedad</label>
            <input type="text" id="edit-temp-variedad" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="edit-temp-cultivo" class="form-label">Cultivo</label>
            <input type="text" id="edit-temp-cultivo" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="edit-temp-fecha" class="form-label">Fecha</label>
            <input type="date" id="edit-temp-fecha" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="edit-temp-cajas" class="form-label">Cajas</label>
            <input type="number" step="0.5" min="0.5" id="edit-temp-cajas" class="form-control" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>
<div class="modal fade" id="modalConfirmarEliminar" tabindex="-1" aria-labelledby="modalConfirmarEliminarLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalConfirmarEliminarLabel">Confirmar Eliminación</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        ¿Estás seguro de que deseas eliminar esta oferta temporal?
      </div>
      <div class="modal-footer">
        <input type="hidden" id="eliminar-temp-id">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" id="btn-confirmar-eliminar-temp">Eliminar</button>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script src="script.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  fetch("php/leer_ofertas_temp.php")
    .then(res => res.json())
    .then(ofertas => {
      const tbody = document.querySelector("#tabla-temp tbody");
      tbody.innerHTML = ""; // Limpiar por si acaso

ofertas.forEach(oferta => {
  const tr = document.createElement("tr");
  tr.setAttribute("data-id", oferta.id);

  const claseVariedad = oferta.nueva_variedad ? "text-danger-nuevo" : "";
  const claseCultivo = oferta.nuevo_cultivo ? "text-danger-nuevo" : "";

  const tooltipVariedad = oferta.nueva_variedad ? ' title="Nueva variedad"' : "";
  const tooltipCultivo = oferta.nuevo_cultivo ? ' title="Nuevo cultivo"' : "";

  tr.innerHTML = `
    <td class="col-articulo">${oferta.articulo}</td>
    <td class="col-variedad ${claseVariedad}" ${tooltipVariedad}>${oferta.variedad}</td>
    <td class="col-cultivo ${claseCultivo}" ${tooltipCultivo}>${oferta.cultivo}</td>
    <td class="col-fecha" data-raw="${oferta.fecha}">${formatearFecha(oferta.fecha)}</td>
    <td class="col-cajas">${oferta.cajas}</td>
    <td>
      <button class="btn btn-sm btn-primary btn-editar-temporal" data-id="${oferta.id}">
        <i class="bi bi-pencil"></i> Editar
      </button>
      <button class="btn btn-sm btn-danger btn-eliminar" data-id="${oferta.id}">
        <i class="bi bi-trash"></i> Eliminar
      </button>
    </td>
  `;

  tbody.appendChild(tr);
});

    })
    .catch(err => {
      console.error("Error al cargar ofertas temporales:", err);
      alert("No se pudieron cargar las ofertas para revisión.");
    });
});

function formatearFecha(fechaStr) {
  if (!fechaStr) return "";
  const partes = fechaStr.split("-");
  return `${partes[2]}/${partes[1]}/${partes[0]}`;
}
// Abrir modal con datos
$(document).on("click", ".btn-editar-temporal", function () {
  const row = $(this).closest("tr");
  $("#edit-temp-id").val(row.data("id"));
  $("#edit-temp-articulo").val(row.find(".col-articulo").text());
  $("#edit-temp-variedad").val(row.find(".col-variedad").text());
  $("#edit-temp-cultivo").val(row.find(".col-cultivo").text());
  $("#edit-temp-fecha").val(row.find(".col-fecha").data("raw"));
  $("#edit-temp-cajas").val(row.find(".col-cajas").text());

  const modal = new bootstrap.Modal(document.getElementById("modalEditarTemporal"));
  modal.show();
});

// Enviar edición
$("#formEditarTemporal").on("submit", function (e) {
  e.preventDefault();

  const datos = {
    id: $("#edit-temp-id").val(),
    articulo: $("#edit-temp-articulo").val(),
    variedad: $("#edit-temp-variedad").val(),
    cultivo: $("#edit-temp-cultivo").val(),
    fecha: $("#edit-temp-fecha").val(),
    cajas: $("#edit-temp-cajas").val()
  };

  $.post("php/actualizar_oferta_temp.php", datos, function (respuesta) {
    if (respuesta.success) {
      alert("Oferta temporal actualizada correctamente.");
      location.reload();
    } else {
      alert("Error al actualizar: " + (respuesta.error || "desconocido."));
    }
  }, "json");
});

$(document).on("click", ".btn-eliminar", function () {
  const id = $(this).data("id");
  $("#eliminar-temp-id").val(id);
  const modal = new bootstrap.Modal(document.getElementById("modalConfirmarEliminar"));
  modal.show();
});
// Ejecutar eliminación confirmada
$("#btn-confirmar-eliminar-temp").on("click", function () {
  const id = $("#eliminar-temp-id").val();

  $.post("php/eliminar_oferta_temp.php", { id: id }, function (respuesta) {
    if (respuesta.success) {
      alert("Oferta temporal eliminada correctamente.");
      location.reload();
    } else {
      alert("Error al eliminar: " + (respuesta.error || "desconocido."));
    }
  }, "json");
});
document.getElementById("btn-confirmar-insercion").addEventListener("click", function () {
  fetch("php/confirmar_importacion.php", {
    method: "POST"
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert("Las ofertas se han insertado correctamente.");
        window.location.href = "oferta.html"; // O donde prefieras
      } else {
        alert("Error al insertar ofertas: " + (data.error || "desconocido."));
      }
    })
   .catch(async err => {
  const responseText = await err.response?.text?.() ?? "Sin detalles";
  console.error("Error:", err, "Respuesta del servidor:", responseText);
  alert("Hubo un error al confirmar la inserción.\n" + responseText);
});

});


</script>

</body>

</html>